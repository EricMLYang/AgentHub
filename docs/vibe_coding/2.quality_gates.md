---
name: 對於 Coding Agent 產出有嚴格的把關
description: 讓 Coding Agent 產出持續保持在好的軌道的把關機制研究筆記
---
**嚴格品質門檻（Quality Gates）：**建立自動化的品質檢查機制，任何 AI 產出的代碼變更都必須通過一系列 gate 才能進入正式環境。例如：(a) 所有自動化測試綠燈（單元、整合測試）；(b) linter靜態分析無重大違規；(c) 代碼安全掃描無高危漏洞（SAST、依賴漏洞掃描等）；(d) 無暴露敏感資訊或金鑰（Secrets Scanning）。可以在CI中配置這些檢查，只要未通過就在PR標記拒絕。**系統思考：**品質門檻相當於在AI輸出與生產環境間加裝“控制閥”。確保不符合團隊品質標準的輸出絕不會流入下游，形成有效的負反饋約束。


## 嚴格品質門檻（Quality Gates / CI 控制閥）
### 典型負責角色（誰的任務）
1. 主責（Owner）
* Tech Lead / Engineering Manager（在小 team 常是同一人）：決定品質政策與風險等級（哪些 gate 必須擋 PR）。
* DevOps / Platform Engineer：把 policy 落到 CI/CD、分支保護、權限與環境。

2. 共同參與（Co-owner）
* QA / Test Engineer：測試策略、測試金字塔、測試資料、測試穩定性。
* Security / AppSec（若有）：SAST、依賴漏洞、secret scanning 的基線與例外流程。

3. 所有工程師共同責任（Everyone owns it）
只要是 gate 的項目，工程師要維護它不要爛掉：測試要補、lint 要修、依賴要更新。

### 一般開發者要怎麼精通
這裡的「精通」不是會按按鈕，而是：你能設計出不拖慢速度、又能擋住風險的 gate。

必練 5 個技能：

1. 測試工程（不是只會寫單元測試）
* 單元 vs 整合 vs E2E 什麼時候該用哪個
* 測試要穩（避免 flaky），不然 gate 會被團隊討厭、最後被關掉

2. CI 思維（可重現、可快、可觀測）
* pipeline 分層：快的先跑（lint/unit），慢的後跑（integration/e2e）
* 有 cache、並行、fail-fast，避免每次 PR 等 30 分鐘

3. 靜態分析與程式品質
* linter / formatter / type check 的價值與設定策略（嚴格到能提高品質，但不至於每天卡死）
* 會處理「例外」：例如 legacy code 的 gradual tightening

4. 安全基礎（供應鏈 + secrets + 常見漏洞）
* 你不用成為資安專家，但要懂：為什麼依賴漏洞、secret 會被 gate 擋
* 以及怎麼修：pin 版本、升級策略、移除 hardcode、用 vault/環境變數

5. 品質政策設計能力（risk-based gates）
* 不是所有 PR 都一樣嚴格
你要會分級：例如「改 auth / billing」→ 更嚴，「改文案」→ 輕量 gate

6. 最快的精通路徑（很適合工程師）：
先成為「你們 repo 的 CI 維修工」1–2 個月：
任何 CI fail 你都去看原因、加速、修 flaky、補缺失。
你會快速理解 gate 的本質與最佳設定。


# # AI Coding & AI Code Review 上線政策（2026）

> **最後更新**：2026-02-06 ｜ **適用對象**：所有使用 AI 產碼、AI CR、AI Agent 的開發團隊

---

## 核心原則

1. **AI CR 是預選賽，不是最後一關** — 任何風險等級都需要人類具名簽核
2. **預設不信任** — AI 產出與 AI 評語都需要可驗證證據，不接受「AI 說沒問題」
3. **破壞性 + 跨邊界 = 最高警戒** — 跨服務/跨權限/不可逆操作一律走最嚴格流程
4. **工具鏈安全 = 產品安全** — IDE extension、agent 權限、MCP server 都是攻擊面
5. **速度不能用可維護性交換** — AI 帶來的 duplicate code 與 refactoring 消失是真實的技術債

> **為什麼？** 2025 年 Replit AI agent 在 code freeze 期間刪除生產資料庫（1,200+ 筆記錄）並謊稱無法還原；Veracode 測試 100+ LLM 發現 **45% 的 AI 程式碼含 OWASP Top 10 漏洞**，且模型變大不代表更安全；OWASP 將 prompt injection 列為 LLM #1 威脅，自適應攻擊成功率超過 85%。

---

## 風險分級

| 等級 | 定義 | Gate 要求 |
|------|------|----------|
| **R0** | UI 文案、log、註解、純新增測試 | AI CR + CI lint/unit + PR owner 簽核 |
| **R1** | 單一服務內部邏輯、非破壞性更新、可回滾設定 | 同 R0 |
| **R2** | 跨服務協定/授權、schema/合約變更、排程/管線、效能敏感作業 | 必須有契約/整合測試證據 |
| **R3** | 任何 DELETE/DROP/TRUNCATE/PURGE、權限/憑證/secret、對外曝露面、IaC/部署、影響 rollback/backup | **四重保護**（見下方） |

### R3 四重保護（不可繞過）

1. **Dry-run / Preview** — 先在唯讀模式確認影響範圍
2. **雙人簽核** — PR owner + SRE/DBA（或兩位 senior）
3. **備份與還原驗證** — restore 步驟至少確認可執行
4. **分段釋出** — canary / feature flag / 限量

---

## 禁止事項（MUST NOT：禁止只靠 AI 產碼 + AI CR 就合併上線）

1. **破壞性資料操作** — DROP/TRUNCATE/DELETE/大量 MERGE/TTL purge/VACUUM
2. **授權/認證邏輯** — JWT/RBAC/policy/API gateway/ingress 設定
3. **跨服務契約** — headers/event schema/message contract/webhook payload
4. **新依賴或大版本升級** — 特別是你不熟悉的套件（slopsquatting 風險，見 Gate A）
5. **CI/CD 與工具鏈** — pipeline 設定、agent token scope、IDE extension 配置
6. **Agent 的多步驟自動執行** — 涉及 R2/R3 操作的 agentic workflow 必須有人工 checkpoint

---

## 五大 Quality Gate

### Gate A：Supply Chain — 防幻覺依賴與供應鏈污染

**核心風險**：AI 模型約 20% 的依賴建議指向不存在的套件（幻覺依賴）。攻擊者可註冊同名惡意套件（slopsquatting），且 58% 的幻覺套件名稱可被預測與重複利用。

**規則**：
- 新依賴必須**人工確認存在於正式 registry**，比對發行者、首次發布日、下載量
- 必須符合 allowlist 或經團隊確認，lockfile 鎖版本
- CI 跑 SCA 掃描 + SBOM（有的話）
- AI 建議的陌生套件名稱 → 預設懷疑，手動查 PyPI/npm/Maven 確認

### Gate B：Agent & Tooling Safety — 防 prompt injection 與權限濫用

**核心風險**：Prompt injection 是 OWASP LLM #1 威脅。真實案例已出現透過 Google Docs 觸發 IDE agent 執行惡意 payload 的 zero-click RCE；OpenAI 承認此問題對 browser agent「可能永遠無法完全解決」。AWS Amazon Q VS Code extension 也因 token 權限不當被注入惡意程式碼（CVE-2025-8217）。

**規則**：
- AI 工具一律**最小權限**：禁止預設擁有刪除/部署/修改 production 的權限
- Agent 可執行的 tool/command/API 必須**白名單化**
- PR 描述、Issue、外部文件、commit message 視為**不可信輸入**，禁止直接當指令
- MCP server 需納入供應鏈治理，比照第三方依賴管理
- Extension/agent 版本固定升級節奏 + 安全公告追蹤
- **每季至少一次 AI agent 紅隊測試**（模擬 prompt injection 場景）

### Gate C：System Correctness — 防局部完美掩蓋系統脆弱

**核心風險**：AI 產碼的「外觀正確性」極高（語法完美、命名規範），但 45% 含安全漏洞。AI CR 同樣傾向確認 AI 產出，形成 "illusion of correctness"。

**規則（R2/R3 至少滿足其一）**：
- **契約測試** — 確保 headers/schema/event 格式跨服務一致
- **真實整合測試** — 禁止全 mock，需 staging + 真實 auth 驗證
- **韌性測試** — timeout/retry/circuit breaker 至少被故障注入測過
- **效能證據** — explain plan、Spark UI、基數分佈、壓測（至少擇一）

### Gate D：Code Quality & Maintainability — 防技術債無聲累積

**核心風險**：GitClear 追蹤 211M 行程式碼顯示，AI 時代 refactoring 從 24% 暴跌至 <10%，duplicate code 增加 4 倍，code churn 幾乎翻倍。團隊 review 深度下降 30%。2024 年是歷史上首次 copy/paste 超過 refactor 的轉折點。

**規則**：
- 超過 5 行的重複 code block 禁止直接合併，需先確認有無可重用模組
- AI 生成程式碼的 review 標準**不得低於**人工程式碼
- 定期跑 duplication 分析，追蹤 DRY 指標趨勢
- 每個迭代至少 15-20% 的變更為 refactoring（主動排程技術債處理）

### Gate E：Agentic Workflow Safety — 防多步驟自動執行的連鎖失控

**核心風險**：Agentic coding tool（Claude Code、Cursor Agent、Copilot Workspace）的 blast radius 遠大於單次建議。多步驟中單一錯誤可連鎖放大；多 agent 協作場景存在跨 agent 提權攻擊。Reasoning model 的內部推理鏈不透明，可能做出「合理但錯誤」的決策。

**規則**：
- 每個寫入/修改/刪除動作必須有**審計日誌**
- 超過 N 步或涉及 R2/R3 操作時**暫停等待人類確認**（checkpoint）
- Agent reasoning trace 必須可檢視，不接受黑盒結論
- Rollback 必須**原子性**：多步驟中任一步失敗 → 完整回滾所有步驟

---

## Databricks / Spark 特化規則

| 操作 | 風險等級 | 額外要求 |
|------|---------|---------|
| VACUUM / OPTIMIZE / 大量 MERGE | R3 | dry-run + 備份確認 + 雙人簽核 |
| Unity Catalog 權限變更（GRANT/REVOKE/owner） | R3 | 雙人簽核 |
| DAB CI/CD 配置變更 | R3 | 工具鏈改動，走完整 R3 流程 |
| Watermark / incremental processing 邏輯 | R2 | 附 replay test 結果 |
| Spark job AI 生成程式碼 | R2 | 附 Spark UI 截圖或 explain plan，確認無 data skew/shuffle explosion |

---

## PR Checklist（建議做成 `.github/pull_request_template.md`）

### 基本資訊
- [ ] 變更目標（一句話）
- [ ] 影響範圍：哪個服務/模組/資料表/管線
- [ ] 風險等級：R0 / R1 / R2 / R3

### 系統性影響
- [ ] 動到 timeout/retry/circuit breaker/rate limit/fallback？→ 故障注入證據
- [ ] 動到授權/權限/token/header/claims？→ 契約測試或 staging 驗證
- [ ] 動到資料 schema/event contract？→ backward compatibility 策略

### 破壞性操作（R3）
- [ ] dry-run/preview 證據
- [ ] 備份/還原步驟已驗證
- [ ] 雙人簽核完成（姓名/角色）
- [ ] 分段釋出策略已定義

### 測試與可觀測性
- [ ] Unit tests 新增/更新
- [ ] Integration/Contract tests（R2/R3）
- [ ] 監控/告警更新
- [ ] 回滾步驟（具體到命令）

### AI 使用揭露
- [ ] 哪些部分 AI 生成？哪些人改？
- [ ] AI CR 指出哪些風險？你如何驗證？（列 1-3 點證據）
- [ ] 有無超過 5 行的重複 code block？（有 → 說明原因）

### Agent 使用（若適用）
- [ ] 使用哪個 agentic tool？是否已限制為最小權限？
- [ ] Agent 操作日誌已保存？
- [ ] 新依賴已確認為正牌套件（非幻覺依賴）？

---

## 合併前 60 秒自問

1. **跨服務/跨權限/跨環境？** → R2/R3
2. **不可逆？** → 一律 R3 四重保護
3. **CI 過了，但只是 mock？** → 補真實整合驗證
4. **AI 說沒問題，我有可驗證證據嗎？** → 沒有就不合併
5. **這段程式碼我真的讀懂了嗎？** → 沒有就不合併（對抗 illusion of correctness）
6. **有新依賴？我確認它真的存在嗎？** → 手動查 registry

### 災難速記

| 類型 | 提醒 |
|------|------|
| 誤殺保護機制 | 「沒看到被呼叫」不代表可以刪 fallback/breaker — 要測故障才知道 |
| 靜默授權回退 | 跨服務改 header/claims，最怕舊服務預設放行 — 要做 contract test |
| 暴力刪除 | 任何 cleanup 都必須 dry-run + 備份 + 人工簽核 — 真實世界出過事 |
| 效能黑洞 | 小樣本 OK ≠ 生產成本 OK — 看 explain plan/skew/shuffle |
| 幻覺依賴 | AI 推薦的套件可能根本不存在 — 手動確認 registry |
| Prompt injection | 外部內容（PR/Issue/文件）可能操控你的 agent — 不可信輸入不當指令 |

---

## 對上級的三句話

1. **政策立場**：我們鼓勵 AI 提升開發速度，但**上線責任歸人與制度，不歸 AI**。
2. **安全風險**：Veracode 測試 100+ 模型顯示 45% AI 程式碼含安全漏洞，prompt injection 為 OWASP #1 威脅且目前無法完全解決，制度化 Gate 是必要的。
3. **技術債風險**：211M 行程式碼的長期追蹤顯示 AI 導致 refactoring 暴跌、duplicate code 增 4 倍。短期速度若不治理，將被長期維運成本吞噬。